pipeline {

	agent any

	stages {
		stage("BUILD") {
			steps {
				echo "build stage"
				sh 'docker build . -f build.dockerfile -t nrbuild'
				sh 'docker volume create nrVolOut'
				sh 'docker run --mount type=volume,src="nrVolOut",dst=/nodered nrbuild:latest bash -c "ls -l && cd .. && cp -r /node-red_fork /nodered"'
			}
		}
		
		stage("TEST") {
			steps {
				echo "test stage"
				sh 'docker build . -f test.dockerfile -t nrtest'
			}
		}
		stage("DEPLOY") {
			steps {
				echo "deploy stage"
				sh 'docker rm -f nrdeploy || true'
				sh 'docker run -dit --name nrdeploy --mount type=volume,src="nrVolOut",dst=/nodered node'
				sh 'docker container exec nrdeploy bash -c "cd nodered"'
				sh 'docker container exec nrdeploy bash -c "ls -l"'
				sh 'docker container exec nrdeploy bash -c "npm start"'
			}
		}
	}
}
	
